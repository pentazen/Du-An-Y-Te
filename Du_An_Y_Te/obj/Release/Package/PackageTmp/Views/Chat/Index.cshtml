
@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>

@*<div class="container">
    <input type="text" id="message" />
    <input type="button" id="sendmessage" value="Send" />
    <input type="hidden" id="displayname" />
    <ul id="discussion"></ul>
</div>*@


<div id="header">
    SignalR Chat Room
</div>
<br />
<br />
<br />

<div id="divContainer">
    <div id="divLogin" class="login">
        <div>
            Please Enter Your Name:<br />
            <input id="txtNickName" type="text" class="textBox" />
        </div>
        <div>
            Please Enter Your Email:<br />
            <input id="txtEmailId" type="text" class="textBox" />
        </div>
        <div id="divButton">
            <input id="btnStartChat" type="button" class="submitButton" value="Start Chat" />
        </div>
    </div>

    <div id="divChat" class="chatRoom">
        <div class="title">
            Welcome to Chat Room [<span id='spanUser'></span>]

        </div>
        <div class="content">
            <div id="divChatWindow" class="chatWindow">
            </div>
            <div id="divusers" class="users">
            </div>
        </div>
        <div class="messageBar">
            <input class="textbox" type="text" id="txtMessage" />
            <input id="btnSendMsg" type="button" value="Send" class="submitButton" />
        </div>
    </div>

    <input id="hdId" type="hidden" />
    <input id="hdUserName" type="hidden" />
    <input id="hdEmailID" type="hidden" />
</div>



























<!--Script references. -->
<!--Reference the jQuery library. -->
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
@*<script src="~/signalr/hubs"></script>*@
<script src="@Url.Content("~/signalr/hubs")" type="text/javascript"></script>
<!--Add script to update the page and send messages.-->

<script src="~/Scripts/ui/jquery.ui.core.js"></script>
<script src="~/Scripts/ui/jquery.ui.widget.js"></script>
<script src="~/Scripts/ui/jquery.ui.mouse.js"></script>
<script src="~/Scripts/ui/jquery.ui.draggable.js"></script>
<script src="~/Scripts/ui/jquery.ui.resizable.js"></script>







<script type="text/javascript">
    //$(function () {
    //    // Declare a proxy to reference the hub.
    //    var chat = $.connection.chatHub;
    //    // Create a function that the hub can call to broadcast messages.
    //    chat.client.broadcastMessage = function (name, message) {
    //        // Html encode display name and message.
    //        var encodedName = $('<div />').text(name).html();
    //        var encodedMsg = $('<div />').text(message).html();
    //        // Add the message to the page.
    //        $('#discussion').append('<li><strong>' + encodedName
    //            + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
    //    };
    //    // Get the user name and store it to prepend to messages.
    //    $('#displayname').val(prompt('Enter your name:', ''));
    //    // Set initial focus to message input box.
    //    $('#message').focus();
    //    // Start the connection.
    //    $.connection.hub.start().done(function () {
    //        $('#sendmessage').click(function () {
    //            // Call the Send method on the hub.
    //            chat.server.send($('#displayname').val(), $('#message').val());
    //            // Clear text box and reset focus for next comment.
    //            $('#message').val('').focus();
    //        });
    //    });
    //});






    $(function () {
        //$('#txtNickName').val("duytung")
        //$('#txtEmailId').val("tung.dao@dirox.net")
        //$('#btnStartChat').click()
        clearInterval(refreshId); // Hủy bỏ việc kiểm tra coi có đang typing hay không
        setScreen(false); // ẩn màn hình chat

        // Declare a proxy to reference the hub.
        var chatHub = $.connection.chatHub; // Tạo Hub
        $.connection.hub.logging = true; // Bắt buộc đăng nhập

        registerClientMethods(chatHub); // đăng ký các sự kiện đăng nhập đăng xuất  cho Hub

        // Start Hub ( chạy Hub )
        $.connection.hub.start().done(function () {
            registerEvents(chatHub) // Đăng ký sự kiện đăng nhập, gửi mail cho Hub
        });
    });
    // ------------------------------------------------------------------Variable (Thuộc Tính Cần) ----------------------------------------------------------------------//
    var loadMesgCount = 10;
    var topPosition = 0;
    var refreshId = null;

    function scrollTop(ctrId) {
        var height = $('#' + ctrId).find('#divMessage')[0].scrollHeight;
        $('#' + ctrId).find('#divMessage').scrollTop(height);
    }
    // ------------------------------------------------------------------Start All Chat ----------------------------------------------------------------------//
    function setScreen(isLogin) {
        if (!isLogin) {
            $("#divChat").hide();
        }
        else {
            $("#divChat").show();
        }
    }

    function registerEvents(chatHub) {
        $("#btnStartChat").click(function () {
            var name = $("#txtNickName").val();
            var email = $('#txtEmailId').val();
            if (name.length > 0 && email.length > 0) {
                $('#hdEmailID').val(email);
                chatHub.server.connect(name, email);
            }
            else {
                alert("Please enter your details");
            }
        });

        $("#txtNickName").keypress(function (e) {
            if (e.which == 13) {
                $("#btnStartChat").click();
            }
        });

        $("#txtMessage").keypress(function (e) {
            if (e.which == 13) {
                $('#btnSendMsg').click();
            }
        });

        $('#btnSendMsg').click(function () {
            var msg = $("#txtMessage").val();
            if (msg.length > 0) {

                var userName = $('#hdUserName').val();
                chatHub.server.sendMessageToAll(userName, msg);
                $("#txtMessage").val('');
            }
        });
    }

    function registerClientMethods(chatHub) {
        // Calls when user successfully logged in
        // Sự kiện đc chạy khi đăng nhập ở server thành công
        chatHub.client.onConnected = function (id, userName, allUsers, messages) {
            setScreen(true);

            $('#hdId').val(id);
            $('#hdUserName').val(userName);
            $('#spanUser').html(userName);

            // Add All Users
            for (i = 0; i < allUsers.length; i++) {
                AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName, allUsers[i].EmailID);
            }

            // Add Existing Messages
            for (i = 0; i < messages.length; i++) {
                AddMessage(messages[i].UserName, messages[i].Message);
            }

            $('.login').css('display', 'none');
        }

        // On New User Connected
        chatHub.client.onNewUserConnected = function (id, name, email) {
            AddUser(chatHub, id, name, email);
        }

        // On User Disconnected
        chatHub.client.onUserDisconnected = function (id, userName) {
            $('#' + id).remove();

            var ctrId = 'private_' + id;
            $('#' + ctrId).remove();

            var disc = $('<div class="disconnect">"' + userName + '" logged off.</div>');

            $(disc).hide();
            $('#divusers').prepend(disc);
            $(disc).fadeIn(200).delay(2000).fadeOut(200);
        }

        // On User Disconnected Existing
        chatHub.client.onUserDisconnectedExisting = function (id, userName) {
            $('#' + id).remove();
            var ctrId = 'private_' + id;
            $('#' + ctrId).remove();
        }

        chatHub.client.messageReceived = function (userName, message) {
            AddMessage(userName, message);
        }

        chatHub.client.sendPrivateMessage = function (windowId, fromUserName, message, userEmail, email, status, fromUserId) {
            var ctrId = 'private_' + windowId;
            if (status == 'Click') {
                if ($('#' + ctrId).length == 0) {
                    createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName, userEmail, email);
                    chatHub.server.getPrivateMessage(userEmail, email, loadMesgCount).done(function (msg) {
                        for (i = 0; i < msg.length; i++) {
                            $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                            // set scrollbar
                            scrollTop(ctrId);
                        }
                    });
                }
                else {
                    $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + fromUserName + '</span>: ' + message + '</div>');
                    // set scrollbar
                    scrollTop(ctrId);
                }
            }

            if (status == 'Type') {
                if (fromUserId == windowId)
                    $('#' + ctrId).find('#msgTypeingName').text('typing...');
            }
            else { $('#' + ctrId).find('#msgTypeingName').text(''); }
        }
    }

    // Add User
    function AddUser(chatHub, id, name, email) {
        var userId = $('#hdId').val();
        var userEmail = $('#hdEmailID').val();
        var code = "";

        if (userEmail == email && $('.loginUser').length == 0) {
            code = $('<div class="loginUser">' + name + "</div>");
        }
        else {
            code = $('<a id="' + id + '" class="user" >' + name + '<a>');
            $(code).click(function () {
                var id = $(this).attr('id');
                if (userEmail != email) {
                    OpenPrivateChatWindow(chatHub, id, name, userEmail, email);
                }
            });
        }

        $("#divusers").append(code);
    }

    // Add Message
    function AddMessage(userName, message) {
        $('#divChatWindow').append('<div class="message"><span class="userName">' + userName + '</span>: ' + message + '</div>');

        var height = $('#divChatWindow')[0].scrollHeight;
        $('#divChatWindow').scrollTop(height);
    }
    // ------------------------------------------------------------------End All Chat ----------------------------------------------------------------------//
    // ------------------------------------------------------------------Start Private Chat ----------------------------------------------------------------------//
    function OpenPrivateChatWindow(chatHub, id, userName, userEmail, email) {
        var ctrId = 'private_' + id;
        if ($('#' + ctrId).length > 0) return;

        createPrivateChatWindow(chatHub, id, ctrId, userName, userEmail, email);

        chatHub.server.getPrivateMessage(userEmail, email, loadMesgCount).done(function (msg) {
            for (i = 0; i < msg.length; i++) {
                $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');
                // set scrollbar
                scrollTop(ctrId);
            }
        });
    }

    function createPrivateChatWindow(chatHub, userId, ctrId, userName, userEmail, email) {

        var div = '<div id="' + ctrId + '" class="ui-widget-content draggable" rel="0">' +
                    '<div class="header">' +
                        '<div  style="float:right;">' +
                            '<img id="imgDelete"  style="cursor:pointer;" src="/Images/delete.png"/>' +
                        '</div>' +

                        '<span class="selText" rel="0">' + userName + '</span>' +
                        '<span class="selText" id="msgTypeingName" rel="0"></span>' +
                    '</div>' +
                    '<div id="divMessage" class="messageArea">' +

                    '</div>' +
                    '<div class="buttonBar">' +
                        '<input id="txtPrivateMessage" class="msgText" type="text"   />' +
                        '<input id="btnSendMessage" class="submitButton button" type="button" value="Send"   />' +
                    '</div>' +
                    '<div id="scrollLength"></div>' +
                '</div>';

        var $div = $(div);

        // ------------------------------------------------------------------ Scroll Load Data ----------------------------------------------------------------------//

        var scrollLength = 2;
        $div.find('.messageArea').scroll(function () {
            if ($(this).scrollTop() == 0) {
                if ($('#' + ctrId).find('#scrollLength').val() != '') {
                    var c = parseInt($('#' + ctrId).find('#scrollLength').val(), 10);
                    scrollLength = c + 1;
                }
                $('#' + ctrId).find('#scrollLength').val(scrollLength);
                var count = $('#' + ctrId).find('#scrollLength').val();

                chatHub.server.getScrollingChatData(userEmail, email, loadMesgCount, count).done(function (msg) {
                    for (i = 0; i < msg.length; i++) {
                        var firstMsg = $('#' + ctrId).find('#divMessage').find('.message:first');

                        // Where the page is currently:
                        var curOffset = firstMsg.offset().top - $('#' + ctrId).find('#divMessage').scrollTop();

                        // Prepend
                        $('#' + ctrId).find('#divMessage').prepend('<div class="message"><span class="userName">' + msg[i].userName + '</span>: ' + msg[i].message + '</div>');

                        // Offset to previous first message minus original offset/scroll
                        $('#' + ctrId).find('#divMessage').scrollTop(firstMsg.offset().top - curOffset);
                    }
                });
            }
        });

        // DELETE BUTTON IMAGE
        $div.find('#imgDelete').click(function () {
            $('#' + ctrId).remove();
        });

        // Send Button event
        $div.find("#btnSendMessage").click(function () {
            $textBox = $div.find("#txtPrivateMessage");
            var msg = $textBox.val();
            if (msg.length > 0) {
                chatHub.server.sendPrivateMessage(userId, msg, 'Click');
                $textBox.val('');
            }
        });

        // Text Box event
        $div.find("#txtPrivateMessage").keyup(function (e) {
            if (e.which == 13) {
                $div.find("#btnSendMessage").click();
            }

            // Typing
            $textBox = $div.find("#txtPrivateMessage");
            var msg = $textBox.val();
            if (msg.length > 0) {
                chatHub.server.sendPrivateMessage(userId, msg, 'Type');
            }
            else {
                chatHub.server.sendPrivateMessage(userId, msg, 'Empty');
            }

            clearInterval(refreshId);
            checkTyping(chatHub, userId, msg, $div, 5000);
        });

        AddDivToContainer($div);
    }

    function checkTyping(chatHub, userId, msg, $div, time) {
        refreshId = setInterval(function () {
            // Typing
            $textBox = $div.find("#txtPrivateMessage");
            var msg = $textBox.val();
            if (msg.length == 0) {
                chatHub.server.sendPrivateMessage(userId, msg, 'Empty');
            }
        }, time);
    }

    function AddDivToContainer($div) {
        $('#divContainer').prepend($div);
        $div.draggable({
            handle: ".header",
            stop: function () {
            }
        });
    }
    // ------------------------------------------------------------------End Private Chat ----------------------------------------------------------------------//
</script>




<style>
    body
{
    padding: 0px;
    margin: 0px;
}

#header
{
    padding: 20px;
    background-color: #d7e5e4;
    border-bottom: #5f9482 solid 2px;
    color: #1e4638;
    font-size: 24px;
}

.submitButton
{
    background-color: #d7e5e4;
    border: #5f9482 solid 1px;
    padding: 4px;
    cursor: pointer;
}

    .submitButton:hover
    {
        background-color: #e1e1e1;
    }

.login
{
    width: 250px;
    margin-left: auto;
    margin-right: auto;
    padding: 10px;
    border: solid 2px #5f9482;
    color: #1e4638;
}

    .login .textBox
    {
        width: 240px;
    }


    .login #divButton
    {
        padding: 4px;
        text-align: right;
    }

.chatRoom
{
    width: 650px;
    margin-left: auto;
    margin-right: auto;
    border: solid 1px gray;
}

    .chatRoom .title
    {
        font-size: 16px;
        font-weight: bold;
        padding: 8px;
        background-color: #d7e5e4;
        border-bottom: solid 1px #5f9482;
    }

    .chatRoom .content
    {
        height: 300px;
        clear: both;
    }

        .chatRoom .content .chatWindow
        {
            float: left;
            width: 409px;
            height: 300px;
            border-right: solid 1px #5f9482;
            overflow-y: scroll;
        }

            .chatRoom .content .chatWindow .message
            {
                padding: 4px;
            }

                .chatRoom .content .chatWindow .message .userName
                {
                    font-weight: bold;
                }

        .chatRoom .content .users
        {
            float: right;
            width: 240px;
            height: 300px;
        }

            .chatRoom .content .users .user
            {
                display: block;
                cursor: pointer;
                padding: 4px;
                background-color: #f9f9f9;
                border-bottom: solid 1px #5f9482;
            }

            .chatRoom .content .users .loginUser
            {
                display: block;
                padding: 4px;
                color: gray;
                border-bottom: solid 1px #5f9482;
            }

            .chatRoom .content .users .user:hover
            {
                background-color: #e1e1e1;
            }

    .chatRoom .messageBar
    {
        border-top: solid 1px gray;
        padding: 4px;
    }

        .chatRoom .messageBar .textbox
        {
            width: 550px;
        }

.disconnect
{
    position: absolute;
    margin: 10px;
    background-color: #ffcbcb;
    padding: 4px;
    border: solid 1px red;
}


.draggable
{
    position: absolute;
    border: #5f9482 solid 1px !important;
    width: 250px;
}

    .draggable .header
    {
        cursor: move;
        background-color: #d7e5e4;
        border-bottom: #5f9482 solid 1px;
        color: #1e4638;
    }

    .draggable .selText
    {
        color: black;
        padding: 4px;
    }

    .draggable .messageArea
    {
        width: 250px;
        overflow-y: scroll;
        height: 200px;
         border-bottom: #5f9482 solid 1px;
    }

        .draggable .messageArea .message
        {
            padding: 4px;
        }

    .draggable .buttonBar
    {
        width: 250px;
       padding:4px;
    }

        .draggable .buttonBar .msgText
        {
            width: 172px;
        }

        .draggable .buttonBar .button
        {
           margin-left:4px;
            width: 55px;
        }

</style>
<link rel="stylesheet" href="~/Content/JQueryUI/themes/base/jquery.ui.all.css" />